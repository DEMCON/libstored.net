# LibStored.Net.Generator

**LibStored.Net.Generator** is a C# Source Generator for the [LibStored.Net](../LibStored.Net/README.md) library. It automates the creation of strongly-typed store classes and variables, reducing boilerplate and ensuring consistency for projects using LibStored.Net.

## Features

- Generates C# code for store classes and variables based on metadata or configuration.
- Integrates with the .NET build process via Roslyn Source Generators.
- Ensures type safety and consistency for store definitions.
- Reduces manual coding and maintenance effort.

## Usage

1. **Add Reference**  
   Reference `LibStored.Net` in your project.

2. **Define Metadata**  
   Describe your store structure in the supported metadata format (see below for details).

   In the future this store metadata JSON will will be generated by libstored, see https://github.com/DEMCON/libstored/issues/76.

3. **Configure AdditionalFiles**  
   In your `.csproj`, add your metadata files as `AdditionalFiles` so the source generator can consume them.  

   > The metadata file is a JSON file, its filename should end with `Store.json`

   For example to use all files in the `Stores` folder ending with `Store.json`:
   ```xml
   <ItemGroup>
     <AdditionalFiles Include="Stores\*Store.json" />
   </ItemGroup>
   ```
   See the `IntegrationTest` project for a working example.

4. **Build Your Project**  
   The generator will automatically create the necessary C# classes and variables during compilation.

5. **Use Generated Code**  
   Access your strongly-typed store classes and variables directly in your codebase.

*Optionally*:

6. **Persist source generated files**
    ```xml
    <PropertyGroup>
        <EmitCompilerGeneratedFiles>true</EmitCompilerGeneratedFiles>
        <CompilerGeneratedFilesOutputPath>Generated</CompilerGeneratedFilesOutputPath>
    </PropertyGroup>

    <ItemGroup>
        <!-- Exclude the output of source generators from the compilation -->
        <Compile Remove="$(CompilerGeneratedFilesOutputPath)/**/*.cs" />
    </ItemGroup>
    ```

## Example

Suppose you define a store metadata file; the generator will produce classes like:

```csharp
public class TestStore : LibStored.Net.Store, INotifyPropertyChanged
{
    public int DefaultInt32 {get; set; }
    public float AmpGain {get; set; }

    // ... more generated members ...
}
```
The getter and setter will be implemented by the source generator to use the underlying buffer in the store.

See [`TestStore`](../../test/LibStored.Net.Tests/TestStore.cs) for an example of generated output.

## Integration Example

See the [`IntegrationTest`](../../test/LibStored.Net.IntegrationTest/) project for a complete example of how to use the source generator, including the required `AdditionalFiles` configuration in the `.csproj`.

## Metadata Format

The metadata JSON file must match the structure defined by `StoreModel` in the generator. Here is an example:

```json
{
  "Name": "TestStore",
  "Hash": "abc123",
  "Variables": [
    {
      "Name": "DefaultInt32",
      "Cname": "default_int32",
      "Type": "int",
      "Ctype": "int32_t",
      "Size": 4,
      "Offset": 0,
      "Init": "0"
    },
    {
      "Name": "AmpGain",
      "Cname": "amp_gain",
      "Type": "float",
      "Ctype": "float",
      "Size": 4,
      "Offset": 4,
      "Init": "1.0"
    }
  ]
}
```

**Fields:**

- `Name` (string, required): The name of the generated store class.
- `Hash` (string, required): A unique hash for the store (used for versioning or identification).
- `Variables` (array, required): List of variable definitions.
  - `Name` (string, required): Variable name in store.
  - `Cname` (string, required): Variable name in C.
  - `Type` (string, required): libstored type (e.g., `int`, `float`).
  - `Ctype` (string, required): C type (e.g., `int32_t`, `float`).
  - `Size` (int, required): Size in bytes.
  - `Offset` (int, required): Offset in the store.
  - `Init` (string, optional): Initial value as a string, the hex encoded version of the initial value of the variable.

## Development

- Target Framework: `netstandard2.0`
- Consumed as a Roslyn Source Generator (analyzer).
- Source code is located in [`src/LibStored.Net.Generator`](.)

## Testing

Testing is performed using multiple projects to ensure the generator works in real-world scenarios:

- **LibStored.Net.Generator.Tests**: 
Contains unit tests for the generator logic.

- **LibStored.Net.IntegrationTest**: 
A sample project that references the generator, configures `AdditionalFiles`, and verifies that generated code compiles and behaves as expected.

- **LibStored.Net.NugetIntegrationTest**: 
The generator is also tested by consuming it as a NuGet package in a separate test project, ensuring that installation and usage via NuGet works as expected. Run this seperate test using the `.\test-nuget.ps1` script in the root.

This multi-project approach ensures both isolated and end-to-end validation of the source generator, including real-world NuGet consumption.
