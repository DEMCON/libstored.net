# LibStored.Net.Generator

**LibStored.Net.Generator** is a C# Source Generator for the [LibStored.Net](../LibStored.Net/README.md) library. It automates the creation of strongly-typed store classes and variables, reducing boilerplate and ensuring consistency for projects using LibStored.Net.

## Features

- Generates C# code for store classes and variables based on metadata or configuration.
- Integrates with the .NET build process via Roslyn Source Generators.
- Ensures type safety and consistency for store definitions.
- Reduces manual coding and maintenance effort.

## Usage

1. **Add Reference**
   Reference `LibStored.Net` in your project.

   > The `LibStored.Net.Generator` is packaged as source generator into the `LibStored.Net` package.

2. **Configure AdditionalFiles**
   In your `.csproj`, add your metadata files as `AdditionalFiles` so the source generator can consume them.

   > The metadata file is a YAML file; its filename should end with `.yml` or `.yaml`

   Use the script `python/generator.py` to generate a metadata file.
   In the future this store metadata file will be generated by libstored, see https://github.com/DEMCON/libstored/issues/76.

   For example to use all files in the `Stores` folder ending with `.yml`:
   ```xml
   <ItemGroup>
     <AdditionalFiles Include="Stores\*.yml" />
   </ItemGroup>
   ```
   See the `IntegrationTest` project for a working example.

*Optionally*:

3. **Persist source generated files**
    ```xml
    <PropertyGroup>
        <EmitCompilerGeneratedFiles>true</EmitCompilerGeneratedFiles>
        <CompilerGeneratedFilesOutputPath>Generated</CompilerGeneratedFilesOutputPath>
    </PropertyGroup>

    <ItemGroup>
        <!-- Exclude the output of source generators from the compilation -->
        <Compile Remove="$(CompilerGeneratedFilesOutputPath)/**/*.cs" />
    </ItemGroup>
    ```

The generator will automatically create the necessary C# classes and variables during compilation.

Access your strongly-typed store classes and variables directly in your codebase.

## Example

Suppose you define a store metadata file `TestStore.yaml`:

```yaml
name: "TestStore"
hash: "abc123"
littleEndian: true
variables:
  - name: "number"
    cname: "number"
    type: "int32"
    size: 4
    offset: 0
    init: 255
  - name: "fraction"
    cname: "fraction"
    type: "double"
    size: 8
    offset: 4
    init: null
```

Add the YAML metadata in your `.csproj` as AdditionalFiles:

```xml
<ItemGroup>
    <AdditionalFiles Include="TestStore.yaml" />
</ItemGroup>
```

the generator will produce classes like:

```csharp
public class TestStore : LibStored.Net.Store, INotifyPropertyChanged
{
    // ... private fields and constructor ...

    public override string Name => "/TestStore";
    public override string Hash => "abc123";
    public override int VariableCount => 2;

    public event PropertyChangedEventHandler? PropertyChanged;

    public int Number {get; set; }
    public double Fraction {get; set; }

    // ... more generated members ...
}
```
The getter and setter will be implemented by the source generator to use the underlying buffer in the store.

See the full [`TestStore`](../../test/LibStored.Net.Tests/TestStore.cs) for an example of generated output.

## Integration Example

See the [`IntegrationTest`](../../test/LibStored.Net.IntegrationTest/) project for a complete example of how to use the source generator, including the required `AdditionalFiles` configuration in the `.csproj`.

## Metadata Format

The metadata YAML file must match the structure defined by `StoreModel` in the generator.

**Fields:**

- `name` (string, required): The name of the generated store class.
- `hash` (string, required): A unique hash for the store (used for versioning or identification).
- `littleEndian` (bool, required): Specifies the endianness of the Store. Only `true` is supported.
- `variables` (array, required): List of variable definitions.
  - `name` (string, required): Variable name in store.
  - `cname` (string, required): Variable name in C.
  - `type` (string, required): libstored type (e.g., `int`, `float`).
  - `ctype` (string, required): C type (e.g., `int32_t`, `float`).
  - `size` (int, required): Size in bytes.
  - `offset` (int, required): Offset in the store.
  - `init` (string / int / float, optional): Initial value. The type depends on the value `Type` field.

## Development

- Target Framework: `netstandard2.0`
- Consumed as a Roslyn Source Generator (analyzer).
- Source code is located in [`src/LibStored.Net.Generator`](.)

## Testing

Testing is performed using multiple projects to ensure the generator works in real-world scenarios:

- **LibStored.Net.Generator.Tests**:
Contains unit tests for the generator logic.

- **LibStored.Net.IntegrationTest**:
A sample project that references the generator, configures `AdditionalFiles`, and verifies that generated code compiles and behaves as expected.

- **LibStored.Net.NugetIntegrationTest**:
The generator is also tested by consuming it as a NuGet package in a separate test project, ensuring that installation and usage via NuGet works as expected. Run this separate test using the `.\test-nuget.ps1` script in the root.

This multi-project approach ensures both isolated and end-to-end validation of the source generator, including real-world NuGet consumption.
